var idEvento=-1,evento=null,puntualidad="0";eventoAsistencia=function(){var e=function(){eventoService.get({idEvento:idEvento},function(e){evento=e,$("#error_card").addClass("hidden"),$("#main_card").removeClass("hidden"),$("#save_card").removeClass("hidden");var t=userInfo.rolSelected;if(p(t,evento.evtTipo))if(selected_id+""!="0"&&"null"!==selected_id){d();var a=!1;if("0"!==evento.evtPart){for(var o=math.intervalStringToArray(evento.evtPart),s=0;s<o.length;s++)if(o[s]+""==selected_id+""){a=!0;break}}else if("0"!==evento.evtExcepcion){a=!0;for(o=math.intervalStringToArray(evento.evtExcepcion),s=0;s<o.length;s++)if(o[s]+""==selected_id+""){a=!1;break}}else a=!0;if(a)if(l(evento))if("0"===evento.evtTipo||"4"===evento.evtTipo||"9"===evento.evtTipo){var n={evento:{idEvento:idEvento},grupo:{idGrupo:selected_id}};eventoService.checkAsistenciaGrupo(n,function(e){!1===e?miembrogpService.list({idGrupo:selected_id},function(e){c(e,0)}):r()})}else if("1"===evento.evtTipo);else if("2"===evento.evtTipo){var i={evento:{idEvento:idEvento},escuela:{idEscuela:selected_id}};eventoService.checkAsistenciaEscuela(i,function(e){!1===e?miembrogpService.listEscuela({idEscuela:selected_id},function(e){c(e,1)}):r()})}else"3"===evento.evtTipo&&miembrogpService.listIglesia({idIglesia:selected_id},function(e){c(e,2)});else $("#save_card").addClass("hidden"),$("#error_card").addClass("hidden");else $("#error_content").html("Lo sentimos, usted o el grupo de peronas al cual lidera no estan invitados a participar en este evento"),$("#main_card").addClass("hidden"),$("#save_card").addClass("hidden"),$("#error_card").removeClass("hidden")}else requestGrupo();else $("#main_card").addClass("hidden"),$("#save_card").addClass("hidden"),$("#error_card").removeClass("hidden")})},r=function(){successMessage({title:"Registro de Asistencia",content:"Ya se realizó el registro de Asistencia"}),$("#main_card").addClass("hidden"),$("#save_card").addClass("hidden"),$("#error_card").addClass("hidden"),setTimeout(function(){location.href=crm_context_path+"/evento/listEvento"},1500)},l=function(e){var t=(new Date).getTime(),a=dateConverter.parse.longToDate(e.evtFecha).getTime(),o=dateConverter.addTime(a,e.evtFechaLimite);return!(t<a)&&(puntualidad=a<=t&&t<=o?"1":"0",!0)},d=function(){components.render("#main_card",components.cardEvent.code([evento],{actions:!1,classes:"l12 m12 s12"}));$("#main_card > .col > .crm-event-container").append('<div id="list_card" style ="border-top:1px solid #eee;padding:16px"></div>'),$("#list_card").append('<table class="card-table"><tbody id="list_body"></tbody></table>')},c=function(e,t){console.log(e);var a=[];if(null!=e){totalCount=e.length;for(var o=0;o<e.length;o++){var s=e[o];switch(t){case 0:a.push(i(s,o));break;case 1:a.push(u(s,o));break;case 2:a.push(v(s,o))}}}else totalFalta=totalVisita=totalPresente=totalCount=0;var n=strings.random(8);components.render("#list_body",components.cardTable.code(a,n)),components.cardTable.event(a,n)},a=function(){var e=!0;return""===$("#asgVisitas").val()&&$("#asgVisitas").val("0"),strings.validate($("#asgLugar").val())||(e=!1,errorMessage({title:"Registro de Asistencia",content:"Debe especificar el lugar de reunión"})),e},i=function(e,t){return{events:[],cols:[{type:"card-table-image",src:e.persona.perFoto,default:appDefaults.defaults.fotoPersona},{type:"card-table-content",label:"",value:e.persona.perNombres+" "+e.persona.perApellidos},{type:"card-table-content",label:"Documento",value:e.persona.perDocumento},{type:"card-table-content",label:"Grupo Pequeño",value:userInfo.grupo.gpoNombre},{type:"card-table-action",button:o("chk_"+t,e.idMiembrogp,"eventoAsistencia.mapMGP()")}]}},u=function(e,t){var a='<select class="browser-default" id="sel_'+t+'" onchange="eventoAsistencia.mapES()" data-persona="'+e.idMiembrogp+'">';return a+='<option value="-1">Ausente</option>',a+='<option value="0">0 días</option>',a+='<option value="1">1 día</option>',a+='<option value="2">2 días</option>',a+='<option value="3">3 días</option>',a+='<option value="4">4 días</option>',a+='<option value="5">5 días</option>',a+='<option value="6">6 días</option>',a+='<option value="7">7 días</option>',a+="</select>",{events:[],cols:[{type:"card-table-image",src:e.persona.perFoto,default:appDefaults.defaults.fotoPersona},{type:"card-table-content",label:"",value:e.persona.perNombres+" "+e.persona.perApellidos},{type:"card-table-content",label:"Grupo Pequeño",value:e.grupo.gpoNombre+"/"+e.grupo.escuela.escNombre},{type:"card-table-action",button:a}]}},v=function(e,t){return{events:[],cols:[{type:"card-table-image",src:e.persona.perFoto,default:appDefaults.defaults.fotoPersona},{type:"card-table-content",label:"",value:e.persona.perNombres+" "+e.persona.perApellidos},{type:"card-table-content",label:"Grupo Pequeño",value:e.grupo.gpoNombre+"/"+e.grupo.escuela.escNombre+"/"+e.grupo.escuela.iglesia.iglNombre},{type:"card-table-action",button:o("chk_"+t,e.idMiembrogp,"eventoAsistencia.mapMGP()")}]}},o=function(e,t,a){return'<div class="switch"><label>F<input type="checkbox" id="'+e+'" data-persona="'+t+'" onclick="'+a+'"><span class="lever"></span> P</label></div>'},p=function(e,t){var a=!1;return e===appDefaults.rols.MIPES_GP||e===appDefaults.rols.LIDER_GP?(selected_id=userInfo.grupo.idGrupo,"0"!==t&&"4"!==t&&"9"!==t||(a=!0)):e===appDefaults.rols.LIDER_MI?(selected_id=userInfo.ministerio.idMinisterio,"1"===t&&(a=!0)):e===appDefaults.rols.MIPES_ES?(selected_id=userInfo.escuela.idEscuela,"2"===t&&(a=!0)):e===appDefaults.rols.MIPES_IG?(selected_id=userInfo.iglesia.idIglesia,"3"===t&&(a=!0)):e===appDefaults.rols.ADMIN&&(a=!0),a};return{init:function(){idEvento=$("#idEvento").val(),$("#error_title").html("Acceso no autorizado"),$("#error_content").html('Lo sentimos, el rol que has seleccionado <strong>"'+appDefaults.rolName(userInfo.rolSelected)+'"</strong> no tiene los privilegios suficientes para realizar esta operación.'),e()},mapMGP:function(){listMGP=[];for(var e=0;e<totalCount;e++)listMGP.push({idPersona:$("#chk_"+e).data("persona"),value:$("#chk_"+e).is(":checked")});var t=0;for(e=0;e<listMGP.length;e++)listMGP[e].value&&(t+=1);totalFalta=totalCount-(totalPresente=t),$("#asgPresentes").html(totalPresente),$("#asgFaltas").html(totalFalta)},mapES:function(){listES=[];for(var e=0;e<totalCount;e++)listES.push({idPersona:$("#sel_"+e).data("persona"),dias:parseInt($("#sel_"+e).val()),value:0<=parseInt($("#sel_"+e).val())?"1":"0"});var t=0;for(e=0;e<listES.length;e++)"1"===listES[e].value&&(t+=1);totalFalta=totalCount-(totalPresente=t),$("#asgPresentes").html(totalPresente),$("#asgFaltas").html(totalFalta)},save:function(){if(a())if("0"===evento.evtTipo||"4"===evento.evtTipo||"9"===evento.evtTipo){var e={id:{idEvento:evento.idEvento,idGrupo:userInfo.grupo.idGrupo},evento:{idEvento:evento.idEvento},grupo:{idGrupo:userInfo.grupo.idGrupo},asgPresentes:totalPresente,asgFaltas:totalFalta,asgVisitas:totalVisita,asgLugar:$("#asgLugar").val(),asgFechaRegistro:1519231804e3,asgPuntualidad:puntualidad};asGrupoService.add(e,function(e){for(var t=[],a=0;a<listMGP.length;a++)t.push({id:{idGrupo:e.idGrupo,idEvento:e.idEvento,idMiembrogp:listMGP[a].idPersona},amgAsistencia:listMGP[a].value?"1":"0"});asmiemgpService.addArray(t,function(e){setTimeout(function(){location.href=crm_context_path+"/evento/listEvento"},1500)})})}else if("2"===evento.evtTipo){var t={id:{idEvento:evento.idEvento,idEscuela:userInfo.escuela.idEscuela},evento:{idEvento:evento.idEvento},escuela:{idEscuela:userInfo.escuela.idEscuela},asePresentes:totalPresente,aseFaltas:totalFalta,aseVisitas:totalVisita,aseLugar:$("#asgLugar").val(),aseFechaRegistro:1519231804e3,asePuntualidad:puntualidad};asEscuelaService.add(t,function(e){for(var t=[],a=0;a<listES.length;a++)t.push({id:{idEvento:e.idEvento,idEscuela:e.idEscuela,idMiembrogp:listES[a].idPersona},ameAsistencia:listES[a].value,ameDias:listES[a].dias});asmiemesService.addArray(t,function(e){setTimeout(function(){location.href=crm_context_path+"/evento/listEvento"},1500)})})}}}}(),$(document).ready(function(){eventoAsistencia.init(),$(".select-buscador").on("select2:select",function(){var e=$(this).val();seleccionarBuscador(e)}),$("#btn_save").click(function(){eventoAsistencia.save()})});var idName=null,selected_id=0,totalCount=0,totalPresente=0,totalVisita=0,totalFalta=0,listMGP=[],listES=[];